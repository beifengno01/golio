#!/bin/bash

set -e

OCAMLBUILD="ocamlbuild -I src -no-links"

for file in $(ls -t tests/*.ml)
do
	name=$(echo $file | sed -e 's/\.ml$//')
	target=$name.d.byte
	if ! $OCAMLBUILD -nothing-should-be-rebuilt $target >/dev/null
	then
		echo "`tput bold`>>> $name`tput sgr0`"
		if ! OCAMLRUNPARAM=b,l=64K $OCAMLBUILD $target --
		then
			rm _build/$target
			exit 1
		fi
	fi
done

for scm in $(ls -t tests/*.scm)
do
	name=$(echo $scm | sed -e 's/\.scm$//')
	echo "`tput bold`>>> $name`tput sgr0`"
	./golio $scm | diff $name.out -
done
