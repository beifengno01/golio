#!/bin/bash

set -e

OCAMLBUILD="ocamlbuild -I lib -no-links"

for file in $(ls -t tests/*.ml)
do
	name=$(echo $file | sed -e 's/\.ml$//')
	target=$name.d.byte
	if ! $OCAMLBUILD -nothing-should-be-rebuilt $target >/dev/null
	then
		echo "`tput bold`>>> $name`tput sgr0`"
		if ! OCAMLRUNPARAM=b,l=2048K $OCAMLBUILD $target --
		then
			rm _build/$target
			exit 1
		fi
	fi
done
